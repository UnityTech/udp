<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/udp/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/udp/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/udp/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/udp/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/udp/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/udp/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/udp/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="Implementing UDP IAP on the server side#The server-side integration consists of the following steps:  Query orders Receive callback notifications  Querying Orders#Your game can query UDP about orders">
<meta property="og:type" content="website">
<meta property="og:title" content="Unity Distribution Platform">
<meta property="og:url" content="https://unitytech.github.io/udp/Implementing-UDP-IAP-on-the-server-side/index.html">
<meta property="og:site_name" content="Unity Distribution Platform">
<meta property="og:description" content="Implementing UDP IAP on the server side#The server-side integration consists of the following steps:  Query orders Receive callback notifications  Querying Orders#Your game can query UDP about orders">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2018-11-09T10:33:24.543Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Unity Distribution Platform">
<meta name="twitter:description" content="Implementing UDP IAP on the server side#The server-side integration consists of the following steps:  Query orders Receive callback notifications  Querying Orders#Your game can query UDP about orders">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/udp/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://unitytech.github.io/udp/Implementing-UDP-IAP-on-the-server-side/"/>





  <title> | Unity Distribution Platform</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/udp/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Unity Distribution Platform</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/udp/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/udp/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-quick-guide">
          <a href="/udp/Quick-Guide/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />
            
            Quick Guide
          </a>
        </li>
      
        
        <li class="menu-item menu-item-document">
          <a href="/udp/UDP-Guide/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />
            
            Document
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    
    
    
    <div class="post-block page">
      <header class="post-header">

	<h1 class="post-title" itemprop="name headline"></h1>



</header>

      
      
      
      <div class="post-body">
        
        
          <p><br></p>
<h2><span id="implementing-udp-iap-on-the-server-side">Implementing UDP IAP on the server side</span><a href="#implementing-udp-iap-on-the-server-side" class="header-anchor">#</a></h2><p>The server-side integration consists of the following steps:</p>
<ul>
<li>Query orders</li>
<li>Receive callback notifications</li>
</ul>
<h3><span id="querying-orders">Querying Orders</span><a href="#querying-orders" class="header-anchor">#</a></h3><p>Your game can query UDP about orders by calling an HTTP GET request.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET https://api-channel.unity.com/v1/order-attempts/query?cpOrderId=&lt;cpOrderId&gt;&amp;clientId=&lt;clientId&gt;&amp;orderQueryToken=&lt;orderQueryToken&gt;&amp;sign=&lt;sign&gt;</span><br></pre></td></tr></table></figure>
<p>Parameters in the request</p>
<table>
<thead>
<tr>
<th>Attribute Name</th>
<th>Format</th>
<th>Required/Optional</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>cpOrderId</td>
<td>String</td>
<td>Required</td>
<td>The order ID assigned by your game, or Unity if the game does not generate it.</td>
<td>66mea52wne</td>
</tr>
<tr>
<td>clientId</td>
<td>String</td>
<td>Required</td>
<td>The client ID assigned by Unity after onboarding.</td>
<td>Q4AnJDW2-rxLAPujqrk1zQ</td>
</tr>
<tr>
<td>orderQueryToken</td>
<td>String</td>
<td>Required</td>
<td>The order query token returned by the client SDK when finishing a purchase.</td>
<td>ebaseakc=</td>
</tr>
<tr>
<td>sign</td>
<td>String</td>
<td>Required</td>
<td>An md5 hash value containing the cpOrderId, clientId, orderQueryToken and Unity Client Secret.</td>
<td>7277da780d1102864ee5818c2730c74e</td>
</tr>
</tbody>
</table>
<p>Parameters in the response</p>
<table>
<thead>
<tr>
<th>Attribute Name</th>
<th>Format</th>
<th>Required/Optional</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>String</td>
<td>Required</td>
<td>The order ID assigned by Unity.</td>
<td>274877943826</td>
</tr>
<tr>
<td>clientId</td>
<td>String</td>
<td>Required</td>
<td>The clientId that is returned by Unity after the game has created a client in the Unity IAP.</td>
<td>Q4AnJDW2-rxLAPujqrk1zQ</td>
</tr>
<tr>
<td>cpOrderId</td>
<td>String</td>
<td>Required</td>
<td>The order ID assigned by your game, or Unity if the game does not generate it.</td>
<td>66mea52wne</td>
</tr>
<tr>
<td>uid</td>
<td>String</td>
<td>Required</td>
<td>A user identifier assigned by Unity.</td>
<td>15400813498</td>
</tr>
<tr>
<td>status</td>
<td>String</td>
<td>Required</td>
<td>Indicates the status of the order.</td>
<td>SUCCESS, FAILED, UNCONFIRMED</td>
</tr>
<tr>
<td>productId</td>
<td>String</td>
<td>Required</td>
<td>The product id associated with the order</td>
<td>Product_1</td>
</tr>
<tr>
<td>payFee</td>
<td>Integer</td>
<td>Required</td>
<td>The payment amount of the order</td>
<td>1</td>
</tr>
<tr>
<td>quantity</td>
<td>Integer</td>
<td>Required</td>
<td>Indicates the quantity of the product.</td>
<td>1</td>
</tr>
<tr>
<td>notified</td>
<td>Boolean</td>
<td>Required</td>
<td>Indicates whether Unity has notified the Game server with the order information.</td>
<td>No</td>
</tr>
<tr>
<td>currency</td>
<td>ISO 4217</td>
<td>Required</td>
<td>Indicates the currency in the purchase.</td>
<td>CNY</td>
</tr>
<tr>
<td>country</td>
<td>ISO 3166-2</td>
<td>Required</td>
<td>Indicates the country or geographic region in which the user is located.</td>
<td>CN</td>
</tr>
<tr>
<td>paidTime</td>
<td>ISO8601 yyyy-MM-ddThh:mm:ssXXX， UTC timezone</td>
<td>Required</td>
<td>Specifies the time when the order is paid.</td>
<td>2017-03-08T06:43:20Z</td>
</tr>
<tr>
<td>createdTime</td>
<td>ISO8601 yyyy-MM-ddThh:mm:ssXXX， UTC timezone</td>
<td>Required</td>
<td>Specifies the time when the order is created.</td>
<td>2017-03-08T06:43:20Z</td>
</tr>
<tr>
<td>updatedTime</td>
<td>ISO8601 yyyy-MM-ddThh:mm:ssXXX， UTC timezone</td>
<td>Required</td>
<td>Specifies the time when the order is updated.</td>
<td>2017-03-08T06:43:20Z</td>
</tr>
<tr>
<td>createdBy</td>
<td>String</td>
<td>Required</td>
<td>The name of the user that created the purchase order. This field is only used for technical support.</td>
<td>274877943822</td>
</tr>
<tr>
<td>updatedBy</td>
<td>String</td>
<td>Required</td>
<td>The name of the user that updated the purchase order. This field is only used for technical support.</td>
<td>0</td>
</tr>
<tr>
<td>rev</td>
<td>String</td>
<td>Required</td>
<td>the revision of the orderAttempt (only for update)</td>
<td>0</td>
</tr>
<tr>
<td>extension</td>
<td>Json String</td>
<td>Optional</td>
<td>extension</td>
<td>{“abc” : “123”}</td>
</tr>
</tbody>
</table>
<p>Here is a sample:</p>
<p>Request:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET </span><br><span class="line">https://api-channel.unity.com/v1/order-attempts/query?cpOrderId=&lt;66mea52wne&gt;&amp;clientId=&lt;Q4AnJDW2-rxLAPujqrk1zQ&gt;&amp;orderQueryToken=&lt;eyJjaGFubmVsVHlwZSI6ICJGQUtFQ0hMIiwgImNoYW5uZWxVaWQiOiAiRkFLRUNITF9oeGQwNSJ9&gt;&amp;sign=&lt;debd0018911d263e23dfb729207b905c&gt;</span><br></pre></td></tr></table></figure>
<p>Response:<br>{<br>“createdBy” : “0”,<br>      “updatedBy” : “0”,<br>      “createdTime” : “2017-03-08T06:43:20Z”,<br>      “updatedTime” : “2017-03-08T06:43:20Z”,<br>      “id” : “274877943826”,<br>      “userId” : “274877943822”,<br>      “status” : “SUCCESS”,<br>     “cpOrderId” : “66mea52wne”,<br>      “clientId” : “Q4AnJDW2-rxLAPujqrk1zQ”,<br>      “uid” : “15400813498”,<br>      “productId” : “Product_1”,<br>    “payFee” : 1,<br>      “quantity” : 1,<br>      “paidTime” : “2017-03-08T06:43:20Z”,<br>      “notified” : false,<br>      “currency” : “CNY”,<br>      “country” : “CN”,<br>      “rev” : “1”<br>}</p>
<h3><span id="receiving-callback-notifications">Receiving callback notifications</span><a href="#receiving-callback-notifications" class="header-anchor">#</a></h3><p>After a purchase succeeds, if you have specified a callback URL, the UDP server notifies the game server with the payment result. Implement an HTTP GET request and accept the following query parameters:</p>
<table>
<thead>
<tr>
<th>Attribute Name</th>
<th>Format</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>payload</td>
<td>Json String</td>
<td>Required</td>
<td>The order content which is in Json String format. See more in Json payload.</td>
</tr>
<tr>
<td>signature</td>
<td>String</td>
<td>Required</td>
<td>The RSA signature with the payload.</td>
</tr>
<tr>
<td>certificate</td>
<td>Base64 encoded String</td>
<td>Required</td>
<td>The X.509 certificate that contains the RSA public key for the signature.</td>
</tr>
</tbody>
</table>
<p><em> Using the certificate </em></p>
<p>You can verify the certificate using the Unity Client RSA Public Key. If the certificate pass the verification, extract the RSA public key from the certificate and use this key to verify the payload with the signature by SHA1 algorithm.</p>
<p>Here is the code sample in Java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.CertificateFactory;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.X509Certificate;</span><br><span class="line"><span class="keyword">import</span> java.security.spec.X509EncodedKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyFactory;</span><br><span class="line"><span class="keyword">import</span> java.security.PublicKey;</span><br><span class="line"><span class="keyword">import</span> java.security.Signature;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">verify</span> <span class="params">(String publicKey, String certificate, String payload, String signature)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// verify certificate</span></span><br><span class="line">	Base64.Decoder decoder = Base64.getDecoder();</span><br><span class="line">	<span class="keyword">byte</span>[] certBytes = decoder.decode(certificate.getBytes(<span class="string">"UTF-8"</span>));</span><br><span class="line">	CertificateFactory certFactory = CertificateFactory.getInstance(<span class="string">"X.509"</span>);</span><br><span class="line">	X509Certificate cert = (X509Certificate)certFactory.generateCertificate(<span class="keyword">new</span> ByteArrayInputStream(certBytes));</span><br><span class="line">	<span class="keyword">byte</span>[] keyBytes = decoder.decode(publicKey.getBytes(<span class="string">"UTF-8"</span>));</span><br><span class="line">	X509EncodedKeySpec keySpec = <span class="keyword">new</span> X509EncodedKeySpec(keyBytes);</span><br><span class="line">	KeyFactory fact = KeyFactory.getInstance(<span class="string">"RSA"</span>);</span><br><span class="line">	PublicKey pubKey = fact.generatePublic(keySpec);</span><br><span class="line">	<span class="keyword">if</span> (cert.notAfter.before(<span class="keyword">new</span> Date())) &#123;</span><br><span class="line">		<span class="comment">// expired certificate, verification failed</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		cert.verify(pubKey);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		<span class="comment">// verification failed</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// verify signature</span></span><br><span class="line">	Signature signature = Signature.getInstance(<span class="string">"SHA1WithRSA"</span>);</span><br><span class="line">	signature.initVerify(cert.getPublicKey());</span><br><span class="line">	signature.update(payload.getBytes(<span class="string">"UTF-8"</span>));</span><br><span class="line">	<span class="keyword">boolean</span> verified = signature.verify(decoder.decode(signature.getBytes(<span class="string">"UTF-8"</span>)));</span><br><span class="line">	<span class="keyword">if</span> (!verified) &#123;</span><br><span class="line">		<span class="comment">// verification failed</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Here is the content of JSON payload:</p>
<table>
<thead>
<tr>
<th>Attribute Name</th>
<th>Required?</th>
<th>Description</th>
<th>Format</th>
<th>Sample</th>
</tr>
</thead>
<tbody>
<tr>
<td>cpOrderId</td>
<td>Yes</td>
<td>order id assigned by Game</td>
<td>String</td>
<td>66mea52wne</td>
</tr>
<tr>
<td>status</td>
<td>Yes</td>
<td>status of the orderAttempt</td>
<td>String</td>
<td>SUCCESS</td>
</tr>
<tr>
<td>amount</td>
<td>Yes</td>
<td>pay fee of this order</td>
<td>String</td>
<td>1</td>
</tr>
<tr>
<td>productId</td>
<td>Yes</td>
<td>product id of the product associated with the order</td>
<td>String</td>
<td>Product_1</td>
</tr>
<tr>
<td>payTime</td>
<td>Yes</td>
<td>order paid time</td>
<td>ISO8601 yyyy-MM-ddThh:mm:ssZ, UTC timezone</td>
<td>2017-03-08T06:43:20Z</td>
</tr>
<tr>
<td>country</td>
<td>Yes</td>
<td>country</td>
<td>ISO 3166-2</td>
<td>US</td>
</tr>
<tr>
<td>currency</td>
<td>Yes</td>
<td>currency</td>
<td>ISO 4217 or cryptocurrency type</td>
<td>USD</td>
</tr>
<tr>
<td>cryptocurrency</td>
<td>Yes</td>
<td>if the currency is cryptocurrency</td>
<td>Boolean</td>
<td>False</td>
</tr>
<tr>
<td>quantity</td>
<td>Yes</td>
<td>quantity of the product</td>
<td>Integer</td>
<td>1</td>
</tr>
<tr>
<td>clientId</td>
<td>Yes</td>
<td>client id returned after Game onboarding to Unity IAP</td>
<td>String</td>
<td>P-wU0n9pbyQ1ulks4kHX_Q</td>
</tr>
<tr>
<td>extension</td>
<td>No</td>
<td>extension</td>
<td>String</td>
<td>“{\”abc\” : \”123\”}”</td>
</tr>
</tbody>
</table>

        
      </div>
      
      
      
    </div>
    
    
    
  </div>


          </div>
          


          
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Unity Technology</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/udp/archives/">
              
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Unity Technology</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/udp/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/udp/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/udp/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/udp/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/udp/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/udp/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/udp/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/udp/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/udp/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/udp/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/udp/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
